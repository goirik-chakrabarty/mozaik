Bootstrap: docker
From: ubuntu:22.04

%help
    Apptainer definition file for Mozaik (Intel MKL Optimized).

%environment
    export MOZAIK_HOME=/opt/mozaik
    export PATH="$MOZAIK_HOME/bin:$PATH"
    export PYTHONPATH="$MOZAIK_HOME/lib/python3.10/site-packages:$PYTHONPATH"
    export DEBIAN_FRONTEND=noninteractive
    export NEST_INSTALL_DIR=$MOZAIK_HOME
    
    # MKL Environment Variables (Critical for performance)
    export MKL_NUM_THREADS=1
    export OMP_NUM_THREADS=1
    export KMP_AFFINITY=granularity=fine,compact,1,0

%files
    . /app

%post
    export MOZAIK_HOME=/opt/mozaik
    export PATH="$MOZAIK_HOME/bin:$PATH"
    export PYTHONPATH="$MOZAIK_HOME/lib/python3.10/site-packages:$PYTHONPATH"
    export DEBIAN_FRONTEND=noninteractive

    # 1. Install System Dependencies (Includes MKL headers)
    apt-get update -y
    apt-get install -y --no-install-recommends \
        build-essential cmake git subversion wget \
        python3 python3-dev python3-pip python3-setuptools python3-venv \
        libopenmpi-dev openmpi-bin \
        libgsl-dev libboost-all-dev \
        libjpeg8-dev zlib1g-dev \
        intel-mkl  # Install Intel MKL system libraries
    
    apt-get clean && rm -rf /var/lib/apt/lists/*

    # 2. Create Virtual Env
    python3 -m venv $MOZAIK_HOME
    . $MOZAIK_HOME/bin/activate

    # 3. Install Intel-Optimized Python Packages (THE FIX)
    pip install --upgrade pip
    
    # We pull numpy from Intel's Anaconda channel to get the MKL-linked version
    pip install -i https://pypi.anaconda.org/intel/simple numpy
    
    # Install other dependencies (standard pip)
    pip install scipy mpi4py matplotlib quantities lazyarray interval \
        Pillow param==1.5.1 parameters neo==0.12.0 cython==3.0.10 psutil \
        future requests elephant pytest-xdist pytest-timeout junitparser \
        numba numpyencoder sphinx imageio scikit-image som-pbc pandas seaborn \
        jupyterlab tk

    # 4. Install Imagen & PyNN
    cd /tmp
    git clone https://github.com/antolikjan/imagen.git
    cd imagen && pip install .
    
    cd /tmp
    git clone https://github.com/CSNG-MFF/PyNN.git
    cd PyNN && git checkout PyNNStepCurrentModule && pip install .

    # 5. Install NEST (Linked to MKL)
    cd /tmp
    wget https://github.com/nest/nest-simulator/archive/v3.4.tar.gz
    tar xvfz v3.4.tar.gz
    cd nest-simulator-3.4
    
    # CMake changes: 
    # -DBLA_VENDOR=Intel10_64lp : Forces CMake to use the MKL library we installed
    # -Dwith-optimize='...'     : Keeps compiler optimizations
    cmake \
        -Dwith-mpi=ON \
        -Dwith-boost=ON \
        -DCMAKE_INSTALL_PREFIX:PATH=$MOZAIK_HOME \
        -Dwith-optimize='-O3 -march=native -mtune=native' \
        -DBLA_VENDOR=Intel10_64lp \
        -Dwith-gsl=ON \
        -Dwith-python=ON \
        ./

    make -j$(nproc) && make install
    
    # 6. Install Step Current Module
    cd /tmp
    git clone https://github.com/CSNG-MFF/nest-step-current-module.git
    cd nest-step-current-module
    cmake \
        -Dwith-mpi=ON \
        -Dwith-boost=ON \
        -Dwith-optimize='-O3 -march=native -mtune=native' \
        -Dwith-nest=$MOZAIK_HOME/bin/nest-config \
        ./
    make -j$(nproc) && make install

    # # Cleanup
    # rm -rf /tmp/*

%runscript
    . $MOZAIK_HOME/bin/activate
    python -c 'import nest; nest.Install("stepcurrentmodule")' > /dev/null 2>&1
    exec python "$@"